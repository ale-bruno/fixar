<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de C칩digo de Barras e QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDvABUDoeTt4LYKg6TO8MixUqqH6UM-kVY",
            authDomain: "srmanuel-c405c.firebaseapp.com",
            databaseURL: "https://srmanuel-c405c-default-rtdb.firebaseio.com",
            projectId: "srmanuel-c405c",
            storageBucket: "srmanuel-c405c.firebasestorage.app",
            messagingSenderId: "928073003564",
            appId: "1:928073003564:web:77940fe83890020ba55789",
            measurementId: "G-KSJYNXDCQ9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Fun칞칚o para salvar produto no Firebase
        window.salvarProdutoNoFirebase = function(codigo, nome, marca, categoria, imagem) {
            console.log("Salvando produto no Firebase...");
            let produto = { codigo, nome, marca, categoria, imagem };
            set(ref(db, 'produtos/' + codigo), produto)
                .then(() => {
                    console.log("Produto salvo com sucesso no Firebase!");
                    alert("Produto salvo com sucesso!");
                })
                .catch((error) => {
                    console.error("Erro ao salvar produto no Firebase: ", error);
                    alert("Erro ao salvar produto no Firebase: " + error.message);
                });
        }

        // Fun칞칚o para buscar produto no Firebase
        async function buscarProdutoNoFirebase(codigo) {
            const produtoRef = ref(db, 'produtos/' + codigo);
            const snapshot = await get(produtoRef);
            if (snapshot.exists()) {
                return snapshot.val();
            } else {
                return null;
            }
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        #scanner-container, #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: auto;
            position: relative;
        }
        video {
            width: 100%;
        }
        button {
            padding: 10px;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }
        #resultado {
            margin-top: 20px;
        }
        img {
            max-width: 200px;
            margin-top: 10px;
        }
        #camera-container {
            display: none;
            position: relative;
            margin-top: 20px;
        }
        #videoElement {
            width: 100%;
        }
        #photoCanvas {
            display: none;
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>Leitor de C칩digo de Barras e QR Code</h1>

    <button onclick="iniciarScanner()">游닝 Escanear C칩digo de Barras</button>
    <div id="scanner-container"></div>

    <h2>Ou escanear QR Code</h2>
    <button onclick="iniciarQrScanner()">游닝 Iniciar QR Code</button>
    <div id="qr-reader" style="display: none;"></div>

    <h2>Ou digite manualmente</h2>
    <input type="text" id="codigoBarras" placeholder="Digite o c칩digo">
    <button onclick="buscarProduto()">Buscar</button>

    <div id="resultado"></div>

    <h2>Captura de Imagem do Produto</h2>
    <button onclick="iniciarCamera()">游닞 Tirar Foto do Produto</button>

    <div id="camera-container">
        <video id="videoElement" autoplay></video>
        <button onclick="tirarFoto()">Tirar Foto</button>
        <canvas id="photoCanvas"></canvas>
    </div>

    <script>
        let cameraStream;

        function iniciarCamera() {
            // Exibir o v칤deo da c칙mera
            document.getElementById("camera-container").style.display = "block";

            // Acessar a c칙mera
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    cameraStream = stream;
                    document.getElementById("videoElement").srcObject = stream;
                })
                .catch(function(error) {
                    alert("Erro ao acessar a c칙mera: " + error.message);
                });
        }

        function tirarFoto() {
            // Obter o canvas para capturar a imagem
            const video = document.getElementById("videoElement");
            const canvas = document.getElementById("photoCanvas");
            const context = canvas.getContext("2d");

            // Definir tamanho do canvas para o tamanho do v칤deo
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Desenhar a imagem do v칤deo no canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Obter a imagem como base64
            const imagemBase64 = canvas.toDataURL("image/png");

            // Exibir a imagem capturada
            const imagemElement = document.createElement("img");
            imagemElement.src = imagemBase64;
            document.getElementById("resultado").innerHTML = "";
            document.getElementById("resultado").appendChild(imagemElement);

            // Parar o stream de v칤deo
            cameraStream.getTracks().forEach(track => track.stop());

            // Armazenar a imagem base64 para o cadastro
            window.imagemProduto = imagemBase64;
        }

        async function buscarProduto() {
            let codigo = document.getElementById("codigoBarras").value;
            let resultadoDiv = document.getElementById("resultado");

            if (codigo === "") {
                resultadoDiv.innerHTML = "<p>Por favor, insira ou escaneie um c칩digo.</p>";
                return;
            }

            console.log("Buscando produto com c칩digo:", codigo);
            let url = `https://world.openfoodfacts.org/api/v0/product/${codigo}.json`;

            try {
                let response = await fetch(url);
                let data = await response.json();

                if (data.status === 1) {
                    let produto = data.product;
                    resultadoDiv.innerHTML = `
                        <h2>${produto.product_name || "Nome n칚o dispon칤vel"}</h2>
                        <p><strong>Marca:</strong> ${produto.brands || "N칚o informado"}</p>
                        <p><strong>Categoria:</strong> ${produto.categories || "N칚o dispon칤vel"}</p>
                        <img src="${produto.image_url || ''}" alt="Imagem do produto">
                    `;
                } else {
                    // Produto n칚o encontrado na API, buscar no Firebase
                    let produtoFirebase = await buscarProdutoNoFirebase(codigo);
                    if (produtoFirebase) {
                        resultadoDiv.innerHTML = `
                            <h2>${produtoFirebase.nome || "Nome n칚o dispon칤vel"}</h2>
                            <p><strong>Marca:</strong> ${produtoFirebase.marca || "N칚o informado"}</p>
                            <p><strong>Categoria:</strong> ${produtoFirebase.categoria || "N칚o dispon칤vel"}</p>
                            <p><strong>C칩digo:</strong> ${produtoFirebase.codigo}</p>
                            <img src="${produtoFirebase.imagem || ''}" alt="Imagem do produto" style="max-width: 200px;">
                        `;
                    } else {
                        if (confirm("Produto n칚o encontrado! Deseja cadastr치-lo?")) {
                            let nome = prompt("Nome do produto:");
                            let marca = prompt("Marca do produto:");
                            let categoria = prompt("Categoria do produto:");
                            let imagem = window.imagemProduto || prompt("URL da imagem do produto:");

                            if (nome && marca && categoria && imagem) {
                                salvarProdutoNoFirebase(codigo, nome, marca, categoria, imagem);
                            } else {
                                alert("Dados incompletos. Produto n칚o cadastrado.");
                            }
                        }
                        resultadoDiv.innerHTML = "<p>Produto n칚o encontrado.</p>";
                    }
                }
            } catch (error) {
                resultadoDiv.innerHTML = "<p>Erro ao buscar produto.</p>";
                console.error("Erro na requisi칞칚o de produto:", error);
            }
        }
    </script>

</body>
</html>
