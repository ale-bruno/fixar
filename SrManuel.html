<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Código de Barras e QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
    <script type="module">
        // Função para iniciar o scanner de código de barras
        function iniciarScanner() {
            console.log("Iniciando scanner de código de barras...");

            // Inicializa o Quagga para leitura do código de barras
            Quagga.init({
                inputStream: {
                    type: 'LiveStream',
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: 'environment'  // Usar a câmera traseira
                    }
                },
                decoder: {
                    readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader'] // Tipos de leitores de código de barras
                }
            }, function(err) {
                if (err) {
                    console.error("Erro ao iniciar Quagga:", err);
                    return;
                }
                Quagga.start(); // Iniciar leitura
                Quagga.onDetected(function(data) {
                    let codigo = data.codeResult.code;
                    alert("Código de barras detectado: " + codigo);
                    // Aqui você pode chamar a função para buscar o produto no Firebase ou outra lógica
                });
            });
        }

        // Função para iniciar o leitor de QR Code
        function iniciarQrScanner() {
            console.log("Iniciando scanner de QR Code...");

            let qrCodeScanner = new ZXing.BrowserQRCodeReader();

            qrCodeScanner.decodeOnceFromVideoDevice(undefined, 'qr-reader').then(result => {
                alert("QR Code detectado: " + result.text);
                // Aqui você pode chamar a função para buscar o produto no Firebase ou outra lógica
            }).catch(err => {
                console.error("Erro ao ler QR Code:", err);
            });
        }

        // Função para acessar a câmera e capturar uma foto do produto
        function iniciarCamera() {
            console.log("Abrindo câmera para capturar imagem...");
            document.getElementById("camera-container").style.display = "block";

            navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }  // Usar a câmera traseira
            }).then(function(stream) {
                document.getElementById("videoElement").srcObject = stream;
            }).catch(function(error) {
                alert("Erro ao acessar a câmera: " + error.message);
            });
        }

        // Função para tirar uma foto
        function tirarFoto() {
            const video = document.getElementById("videoElement");
            const canvas = document.getElementById("photoCanvas");
            const context = canvas.getContext("2d");

            // Definir o tamanho do canvas para o tamanho do vídeo
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Desenhar a imagem do vídeo no canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Converter a imagem para Base64
            const imagemBase64 = canvas.toDataURL("image/png");

            // Exibir a imagem capturada
            const imagemElement = document.createElement("img");
            imagemElement.src = imagemBase64;
            document.getElementById("resultado").innerHTML = "";
            document.getElementById("resultado").appendChild(imagemElement);
        }
    </script>
</head>
<body>
    <h1>Leitor de Código de Barras e QR Code</h1>

    <!-- Botões -->
    <button onclick="iniciarScanner()">Iniciar Scanner de Código de Barras</button>
    <div id="scanner-container" style="width: 100%; height: 300px; border: 1px solid black;"></div>

    <button onclick="iniciarQrScanner()">Iniciar Scanner de QR Code</button>
    <div id="qr-reader" style="width: 100%; height: 300px;"></div>

    <h2>Capturar Imagem do Produto</h2>
    <button onclick="iniciarCamera()">Abrir Câmera</button>

    <div id="camera-container" style="display: none;">
        <video id="videoElement" autoplay style="width: 100%;"></video>
        <button onclick="tirarFoto()">Tirar Foto</button>
        <canvas id="photoCanvas" style="display: none;"></canvas>
    </div>

    <div id="resultado"></div>
</body>
</html>
